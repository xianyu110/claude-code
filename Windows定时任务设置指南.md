# Windows定时任务设置指南

## 🎯 目标
设置Windows任务调度器，每天自动运行小红书AI话题采集脚本，并将数据上传到飞书。

## 📋 前置准备

### 1. 确认环境
- ✅ Node.js 已安装 (版本 >= 16.0.0)
- ✅ 依赖包已安装 (`npm install`)
- ✅ Playwright 浏览器已安装 (`npx playwright install chromium`)
- ✅ 飞书配置已完成 (`node daily_ai_scraper.js setup`)

### 2. 测试脚本
```bash
# 测试采集功能（不上传）
node daily_ai_scraper.js test

# 测试完整流程
node daily_ai_scraper.js run
```

## 🔧 Windows任务调度器设置步骤

### 第一步：打开任务调度器
1. 按 `Win + R` 键，输入 `taskschd.msc`，按回车
2. 或者在开始菜单搜索"任务调度器"

### 第二步：创建基本任务
1. 在右侧点击 **"创建基本任务"**
2. 输入任务名称：`小红书AI话题每日采集`
3. 输入描述：`每天自动采集小红书AI话题并上传到飞书`
4. 点击 **"下一步"**

### 第三步：设置触发器
1. 选择 **"每天"**
2. 点击 **"下一步"**
3. 设置开始时间：建议 `上午 09:00`
4. 设置开始日期：选择今天或明天
5. 每隔天数：`1` (每天执行)
6. 点击 **"下一步"**

### 第四步：设置操作
1. 选择 **"启动程序"**
2. 点击 **"下一步"**
3. 程序或脚本：输入批处理文件的完整路径
   ```
   D:\Cursor编程\run_daily_scraper.bat
   ```
4. 添加参数：`auto` (表示自动运行，不等待用户输入)
5. 起始于：输入项目目录路径
   ```
   D:\Cursor编程
   ```
6. 点击 **"下一步"**

### 第五步：完成设置
1. 勾选 **"当单击'完成'时，打开此任务属性的对话框"**
2. 点击 **"完成"**

### 第六步：高级设置（重要）
在弹出的属性对话框中：

#### 常规选项卡：
- ✅ 勾选 **"不管用户是否登录都要运行"**
- ✅ 勾选 **"使用最高权限运行"**
- 设置运行账户：选择当前用户账户

#### 触发器选项卡：
- 点击触发器，然后点击 **"编辑"**
- ✅ 勾选 **"已启用"**
- 点击 **"确定"**

#### 操作选项卡：
- 确认程序路径和参数正确

#### 条件选项卡：
- ❌ 取消勾选 **"只有在计算机使用交流电源时才启动此任务"**
- ❌ 取消勾选 **"只有在以下网络连接可用时才启动此任务"**

#### 设置选项卡：
- ✅ 勾选 **"允许按需运行任务"**
- ✅ 勾选 **"如果过了计划开始时间，立即启动任务"**
- ✅ 勾选 **"如果任务失败，按以下间隔重新启动"**：`1分钟`，重启次数：`3`
- 设置 **"如果任务运行时间超过以下时间则停止任务"**：`2小时`

### 第七步：保存并测试
1. 点击 **"确定"** 保存设置
2. 在任务列表中找到刚创建的任务
3. 右键点击任务，选择 **"运行"** 进行测试

## 📊 任务监控和管理

### 查看运行状态
1. 在任务调度器中，选择您的任务
2. 查看 **"上次运行时间"** 和 **"上次运行结果"**
3. 状态码含义：
   - `0x0`：成功完成
   - `0x1`：失败或错误

### 查看运行日志
1. 在任务调度器中，点击左侧 **"任务调度器库"**
2. 选择您的任务，点击下方 **"历史记录"** 选项卡
3. 或者查看脚本生成的日志文件：`./data/daily_scraper.log`

### 修改运行时间
1. 双击任务进入属性
2. 切换到 **"触发器"** 选项卡
3. 选择触发器，点击 **"编辑"**
4. 修改时间，点击 **"确定"**

## 🔔 通知设置（可选）

### 邮件通知
在 `daily_ai_scraper.js` 中可以添加邮件通知功能：
```javascript
// 在 sendNotification 方法中添加邮件发送逻辑
// 需要配置 nodemailer 或其他邮件服务
```

### 企业微信通知
```javascript
// 在 sendNotification 方法中添加企业微信机器人通知
// 通过 webhook 发送消息到企业微信群
```

## 🛠️ 故障排除

### 常见问题和解决方案

#### 1. 任务状态显示"失败"
- 检查 Node.js 是否正确安装
- 确认项目路径没有中文字符或特殊符号
- 查看 `./data/daily_scraper.log` 中的错误信息

#### 2. 浏览器无法启动
- 确认 Playwright 浏览器已安装：`npx playwright install chromium`
- 检查是否有足够的系统权限
- 确认系统有足够的内存和存储空间

#### 3. 飞书上传失败
- 重新运行飞书设置：`node daily_ai_scraper.js setup`
- 检查飞书登录状态是否有效
- 确认网络连接正常

#### 4. 数据采集为空
- 检查小红书网站是否可正常访问
- 确认网页结构是否发生变化
- 运行测试模式检查采集逻辑：`node daily_ai_scraper.js test`

#### 5. 权限问题
- 确保任务调度器使用管理员权限
- 检查文件夹访问权限
- 确认防火墙和杀毒软件没有阻止程序运行

## 📅 推荐的运行时间

| 时间段 | 推荐度 | 说明 |
|--------|---------|------|
| 上午 9:00 | ⭐⭐⭐⭐⭐ | 工作时间开始，数据新鲜 |
| 上午 10:00 | ⭐⭐⭐⭐ | 避开网络高峰期 |
| 下午 2:00 | ⭐⭐⭐ | 午休后，新内容更新 |
| 晚上 8:00 | ⭐⭐ | 用户活跃期，但可能网络拥堵 |
| 凌晨 2:00 | ⭐ | 网络空闲，但数据可能不够新鲜 |

## 🔄 维护建议

### 每周检查
- 查看任务执行日志
- 确认数据质量和数量
- 检查飞书表格数据更新情况

### 每月维护
- 清理旧的日志文件
- 更新依赖包版本
- 检查脚本性能和优化空间

### 备份重要文件
- `feishu_config.json` - 飞书配置
- `./data/master_topics.json` - 主数据文件
- `./data/scraping_history.json` - 采集历史

## 📞 技术支持
如果遇到技术问题，请：
1. 首先查看 `./data/daily_scraper.log` 日志文件
2. 运行测试模式确认问题范围
3. 检查网络连接和系统权限
4. 重新运行设置向导

---
*最后更新时间：2025年1月* 