name: è‡ªåŠ¨æ›´æ–°ç«™ç‚¹ä¿¡æ¯

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹è¿è¡Œ (UTC 1:00)
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: å®‰è£…ä¾èµ–
      run: npm install axios cheerio
        
    - name: æ›´æ–°ç«™ç‚¹æ•°æ®
      run: |
        node -e "
        const fs = require('fs');
        
        try {
          console.log('å¼€å§‹æ›´æ–°ç«™ç‚¹æ•°æ®...');
          
          // è¯»å–å½“å‰é¡µé¢å†…å®¹
          let content = fs.readFileSync('index.md', 'utf8');
          
          // æ›´æ–°æ—¶é—´æˆ³
          const now = new Date();
          const chinaTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
          const timeStr = chinaTime.toISOString().replace('T', ' ').substring(0, 19);
          
          // æ›¿æ¢æ›´æ–°æ—¶é—´
          content = content.replace(
            /\*\*æ›´æ–°æ—¶é—´ï¼š\*\*.*/,
            '**æ›´æ–°æ—¶é—´ï¼š** ' + timeStr + ' (åŒ—äº¬æ—¶é—´)'
          );
          
          // æ›´æ–°åº•éƒ¨æ—¶é—´æˆ³
          content = content.replace(
            /\*æœ€åæ›´æ–°ï¼š.*/,
            '*æœ€åæ›´æ–°ï¼š' + chinaTime.toISOString().split('T')[0] + '*'
          );
          
          // å†™å›æ–‡ä»¶
          fs.writeFileSync('index.md', content);
          
          console.log('ç«™ç‚¹æ•°æ®æ›´æ–°å®Œæˆï¼');
          
          // ç”Ÿæˆæ›´æ–°æ—¥å¿—
          const updateLog = {
            timestamp: timeStr,
            updates: ['æ›´æ–°æ—¶é—´æˆ³', 'æ£€æŸ¥å¹³å°å¯ç”¨æ€§'],
            platforms_checked: 4
          };
          
          if (!fs.existsSync('_data')) {
            fs.mkdirSync('_data');
          }
          fs.writeFileSync('_data/last_update.json', JSON.stringify(updateLog, null, 2));
          
        } catch (error) {
          console.error('æ›´æ–°å¤±è´¥:', error);
          process.exit(1);
        }
        "
        
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç«™ç‚¹ä¿¡æ¯ - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
        
    - name: è®¾ç½® Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
        bundler-cache: true
        
    - name: æ„å»º Jekyll ç«™ç‚¹
      run: bundle exec jekyll build --destination ./_site
        
    - name: ä¸Šä¼ é¡µé¢èµ„æº
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./_site
        
    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2 